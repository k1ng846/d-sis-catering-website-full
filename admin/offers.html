<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Offers - d'sis Catering</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link rel="stylesheet" href="admin-layout.css">
    <script src="../js/config.js"></script>
    <style>
        /* === COLOR VARIABLES from main.css === */
        :root {
            /* Accent colors */
            --royal-blue: #007bff8f;
            --gold-accent: #d4af37;
            
            /* BACKGROUND COLORS */
            --body-start-color: #050505; 
            --header-footer-bg: #111010; 
            --card-background: #111010; 
            --sidebar-bg: #111010;

            /* Darker shades for hover */
            --royal-blue-darker: #0056b38f; 
            --gold-accent-darker: #b3902f;
            
            /* Text & Borders */
            --text-main: #ffffff;
            --text-muted: #aaaaaa;
            --border-color: #333333;
            --bg-hover: rgba(255, 255, 255, 0.05);
            --input-bg: #1a1a1a;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body { 
            font-family: Arial, sans-serif; 
            background-color: var(--body-start-color); 
            color: var(--text-main); 
        }

        /* === HEADER === */
        .header { 
            background: var(--header-footer-bg); 
            padding: 20px 40px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.5); 
            display: flex; justify-content: space-between; align-items: center; 
            border-bottom: 1px solid var(--gold-accent); /* Gold Outline */
        }
        
        .logo-section { display:flex; align-items:center }
        .logo-image { 
            width:80px; height:80px; border-radius:50%; 
            margin-right:20px; object-fit:cover;
            border: 2px solid var(--gold-accent);
        }
        .company-name { font-size:32px; font-weight:bold; color:var(--text-main); }
        .admin-section { text-align:right }
        
        .admin-title { font-size:24px; font-weight:bold; color: white; margin-bottom:10px }
        
        .mail-button { 
            background:none; 
            border: 2px solid var(--gold-accent); 
            border-radius:50%; width:60px; height:60px; 
            cursor:pointer; display:flex; align-items:center; justify-content:center; 
            transition:all 0.3s; color: white; text-decoration: none;
        }
        .mail-button:hover{ background:var(--royal-blue); border-color:var(--royal-blue); color:white }
        .mail-button i { font-size: 24px; }

        /* === MAIN LAYOUT === */
        .main-content { 
            display:flex; 
            min-height: calc(100vh - 120px); 
        }
        
        /* === MOBILE RESPONSIVENESS === */
        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
            }
            
            .header {
                padding: 15px 20px;
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
            
            .logo-section {
                justify-content: center;
            }
            
            .logo-image {
                width: 60px;
                height: 60px;
                margin-right: 15px;
            }
            
            .company-name {
                font-size: 24px;
            }
            
            .admin-title {
                font-size: 20px;
                margin-bottom: 5px;
            }
            
            .mail-button {
                width: 50px;
                height: 50px;
            }
            
            .mail-button i {
                font-size: 20px;
            }
        }
        
        /* === SIDEBAR === */
        .sidebar { 
            background: var(--sidebar-bg); 
            width:250px; padding:30px 20px; 
            position:relative; 
            border-right: 1px solid var(--gold-accent);
        }
        
        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                padding: 20px 15px;
                border-right: none;
                border-bottom: 1px solid var(--gold-accent);
            }
            
            .sidebar-title {
                font-size: 24px;
                margin-bottom: 20px;
            }
            
            .nav-menu {
                display: flex;
                flex-wrap: wrap;
                gap: 10px;
                justify-content: center;
            }
            
            .nav-menu li {
                margin-bottom: 0;
                flex: 1 1 auto;
                min-width: 120px;
            }
            
            .nav-menu a {
                padding: 8px 12px;
                font-size: 14px;
                text-align: center;
                justify-content: center;
                min-height: 40px;
            }
        }
        .sidebar-title { 
            color:var(--text-main); font-size:28px; font-weight:bold; 
            margin-bottom:30px; text-align:center;
            border-bottom: 2px solid var(--royal-blue); padding-bottom: 15px;
        }
        
        .nav-menu { list-style:none }
        .nav-menu li { margin-bottom:15px }
        .nav-menu a { 
            color:var(--text-muted); text-decoration:none; 
            padding:12px 15px; display:flex; align-items: center; gap: 10px;
            border-radius:8px; transition:all 0.3s;
            border: 1px solid transparent;
        }
        .nav-menu a:hover { 
            background: rgba(0, 123, 255, 0.1); 
            color: var(--royal-blue); border-color: var(--royal-blue);
        }
        .nav-menu a.active { 
            background: var(--royal-blue); 
            color:white; font-weight: bold;
            box-shadow: 0 0 10px rgba(0, 123, 255, 0.4);
        }

        /* === CONTENT AREA === */
        .content-area { flex:1; padding:30px }
        
        @media (max-width: 768px) {
            .content-area {
                padding: 20px 15px;
            }
            
            .page-title {
                font-size: 24px;
                margin-bottom: 20px;
                text-align: center;
            }
        }
        .page-title { 
            font-size:32px; font-weight:bold; 
            color:var(--text-main); margin-bottom:20px 
        }

        /* === FORMS & CARDS === */
        .card { 
            background:var(--card-background); 
            padding:20px; border-radius:12px; 
            box-shadow:0 4px 6px rgba(0,0,0,0.3); 
            margin-bottom:20px;
            border: 1px solid var(--border-color);
        }
        
        .card h3 { color: var(--gold-accent); border-bottom: 1px solid var(--border-color); padding-bottom: 10px; margin-bottom: 15px; }

        .form-row { display:flex; gap:12px; margin-bottom:12px }
        
        @media (max-width: 768px) {
            .form-row {
                flex-direction: column;
                gap: 15px;
            }
            
            .card {
                padding: 15px;
                margin-bottom: 15px;
            }
            
            .card h3 {
                font-size: 18px;
                margin-bottom: 10px;
            }
        }
        
        input[type=text], input[type=datetime-local], input[type=number], textarea { 
            flex:1; padding:10px; 
            background: var(--input-bg); color: var(--text-main);
            border:1px solid var(--border-color); border-radius:6px;
            font-size: 14px;
        }
        input:focus, textarea:focus { outline: none; border-color: var(--royal-blue); }
        textarea{ min-height:100px }

        /* === FILE UPLOAD STYLING === */
        .file-upload-container {
            flex: 1;
            position: relative;
        }

        .file-upload-input {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .file-upload-label {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 10px;
            background: var(--input-bg);
            color: var(--text-main);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            min-height: 42px;
        }

        .file-upload-label:hover {
            border-color: var(--royal-blue);
            background: rgba(0, 123, 255, 0.1);
        }

        .file-upload-label i {
            font-size: 16px;
            color: var(--gold-accent);
        }

        .image-preview {
            margin-top: 10px;
            display: none;
        }

        .preview-image {
            max-width: 200px;
            max-height: 150px;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            display: block;
        }

        .preview-text {
            margin-top: 5px;
        }

        .preview-text small {
            color: var(--text-muted);
        }

        /* === INPUT GROUP STYLING === */
        .input-group {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .input-label {
            color: var(--gold-accent);
            font-weight: bold;
            font-size: 14px;
            margin-bottom: 5px;
        }

        .input-group input,
        .input-group textarea {
            margin: 0;
        }

        /* === SCROLLABLE CONTAINERS === */
        .scroll-container {
            max-height: 500px;
            overflow-y: auto;
            padding-right: 5px;
            margin-top: 12px;
        }

        .scroll-container::-webkit-scrollbar {
            width: 12px;
        }

        .scroll-container::-webkit-scrollbar-track {
            background: var(--card-background);
            border-radius: 6px;
        }

        .scroll-container::-webkit-scrollbar-thumb {
            background: var(--gold-accent);
            border-radius: 6px;
            border: 2px solid var(--card-background);
        }

        .scroll-container::-webkit-scrollbar-thumb:hover {
            background: var(--gold-accent-darker);
        }

        /* === OFFERS GRID === */
        .offers-grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap:16px; }
        
        @media (max-width: 768px) {
            .offers-grid {
                grid-template-columns: 1fr;
                gap: 12px;
                margin-top: 15px;
            }
        }
        
        .offer-card { 
            background:#1a1a1a; border-radius:8px; padding:15px; 
            border:1px solid var(--border-color); 
            display:flex; flex-direction:column; gap:8px;
            transition: transform 0.2s, box-shadow 0.2s;
            border-left: 4px solid var(--gold-accent);
        }
        .offer-card:hover { transform: translateY(-3px); box-shadow: 0 4px 10px rgba(0,0,0,0.5); border-color: var(--royal-blue); }

        .offer-card strong { color: var(--text-main); font-size: 1.1em; }
        .offer-desc { color: var(--text-muted); font-size: 0.9em; margin: 5px 0; }
        .offer-dates { font-size:12px; color:var(--royal-blue); font-weight: bold; }
        
        .offer-actions { margin-top:10px; display:flex; gap:8px; justify-content:flex-end }
        
        @media (max-width: 768px) {
            .offer-card {
                padding: 12px;
            }
            
            .offer-actions {
                flex-direction: column;
                gap: 8px;
                justify-content: stretch;
            }
            
            .offer-actions .btn {
                width: 100%;
                justify-content: center;
            }
            
            .offer-card strong {
                font-size: 16px;
            }
            
            .offer-desc {
                font-size: 14px;
            }
            
            .offer-dates {
                font-size: 11px;
            }
        }

        /* === BUTTONS === */
        .btn { padding:8px 14px; border:none; border-radius:6px; cursor:pointer; font-weight:600; transition: 0.3s; }
        .btn-primary { background:var(--royal-blue); color:#fff }
        .btn-primary:hover { background:var(--royal-blue-darker) }
        
        .btn-danger { background:#dc3545; color:#fff }
        .btn-danger:hover { background:#a71d2a }
        
        .btn-secondary { background:transparent; border: 1px solid var(--text-muted); color:var(--text-muted) }
        .btn-secondary:hover { border-color: var(--text-main); color: var(--text-main); }

        /* === MODAL STYLES (Confirmation) === */
        .modal {
            display: none; position: fixed; z-index: 1000;
            left: 0; top: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.8); backdrop-filter: blur(5px);
        }
        
        .modal-content {
            background-color: var(--card-background);
            margin: 15% auto; padding: 0; border-radius: 12px;
            width: 90%; max-width: 450px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.6);
            border: 2px solid var(--gold-accent); /* Gold Outline for Confirmation */
            color: var(--text-main);
            animation: fadeIn 0.3s;
        }
        
        @media (max-width: 768px) {
            .modal-content {
                margin: 10% auto;
                width: 95%;
                max-width: none;
            }
            
            .modal-header h3 {
                font-size: 18px;
            }
            
            .modal-body {
                padding: 15px;
            }
            
            .modal-actions {
                flex-direction: column;
                gap: 10px;
            }
            
            .modal-actions .btn {
                width: 100%;
            }
        }
        
        .modal-header {
            background: #000; color: white; padding: 15px 20px;
            border-radius: 12px 12px 0 0; display: flex;
            justify-content: space-between; align-items: center;
            border-bottom: 1px solid var(--gold-accent);
        }
        
        .modal-header h3 { margin: 0; color: var(--gold-accent); font-size: 1.2rem; }
        
        .close { color: var(--text-muted); font-size: 24px; cursor: pointer; }
        .close:hover { color: var(--gold-accent); }
        
        .modal-body { padding: 20px; text-align: center; }
        .modal-body p { margin-bottom: 20px; font-size: 1.1em; }
        
        .modal-actions {
            display: flex; justify-content: flex-end; gap: 10px;
            margin-top: 20px;
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }

        /* === UTILITY === */
        .loading { text-align:center; padding:24px; color:var(--text-muted) }
        .error { background:#3d0a0e; color:#ff6b6b; padding:12px; border-radius:6px; border: 1px solid #dc3545; }
        .success { background:#0a2912; color:#4cd137; padding:12px; border-radius:6px; border: 1px solid #28a745; }
    </style>
</head>
<body>
    <header class="header">
        <div class="logo-section">
            <img src="pics/logo.png" alt="d'sis Catering Logo" class="logo-image">
            <div class="company-name">d'sis Catering</div>
        </div>
        <div class="admin-section">
            <div class="admin-title">Admin</div>
            <a class="mail-button" href="profile.html" title="Profile">
                <i class="fas fa-user-cog"></i>
            </a>
        </div>
    </header>

    <div class="main-content">
        <div class="sidebar">
            <div class="sidebar-title">Admin</div>
            <ul class="nav-menu">
                <li><a href="dashboard.html"><i class="fas fa-tachometer-alt"></i> Dashboard</a></li>
                <li><a href="bookings.html"><i class="fas fa-calendar-check"></i> Bookings</a></li>
                <li><a href="admin_message.html"><i class="fas fa-envelope"></i> Messages</a></li>
                <li><a href="offers.html" class="active"><i class="fas fa-tags"></i> Offers</a></li>
                <li><a href="menu_management.html"><i class="fas fa-utensils"></i> Menu Management</a></li>
                <li><a href="profile.html"><i class="fas fa-user-cog"></i> Profile Settings</a></li>
                <li><a href="../main.html"><i class="fas fa-home"></i> View Site</a></li>
                <li><a href="#" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
            </ul>
        </div>

        <div class="content-area">
            <h1 class="page-title">Manage Offers</h1>

            <div id="messages"></div>

            <div class="card">
                <h3>Create Offer</h3>
                <form id="offerForm">
                    <div class="form-row">
                        <div class="input-group">
                            <label for="title" class="input-label">Offer Title</label>
                            <input type="text" id="title" placeholder="e.g. Holiday Special Offer" required>
                        </div>
                        <div class="input-group">
                            <label class="input-label">Offer Image</label>
                            <div class="file-upload-container">
                                <label for="imageUpload" class="file-upload-label">
                                    <i class="fas fa-upload"></i>
                                    <span>Choose Image File</span>
                                </label>
                                <input type="file" id="imageUpload" accept="image/*" class="file-upload-input">
                                <div id="imagePreview" class="image-preview">
                                    <img id="previewImg" class="preview-image">
                                    <div class="preview-text">
                                        <small>Selected image preview</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="input-group">
                            <label for="startAt" class="input-label">Start Date & Time</label>
                            <input type="datetime-local" id="startAt">
                        </div>
                        <div class="input-group">
                            <label for="endAt" class="input-label">End Date & Time</label>
                            <input type="datetime-local" id="endAt">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="input-group">
                            <label for="description" class="input-label">Description (Optional)</label>
                            <textarea id="description" placeholder="Describe your offer details here..."></textarea>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="input-group">
                            <label for="benefits" class="input-label">Benefits/Features</label>
                            <textarea id="benefits" placeholder="List the benefits and features of this offer (e.g., Free appetizer, 20% discount, etc.)" required></textarea>
                        </div>
                    </div>
                    <div style="text-align:right">
                            <button type="button" id="cancelEdit" class="btn btn-secondary" style="display:none;margin-right:8px">Cancel</button>
                            <button id="submitBtn" class="btn btn-primary" type="submit">Create Offer</button>
                    </div>
                </form>
            </div>

            <div class="card">
                <h3>Create Promo Code</h3>
                <form id="promoForm">
                    <div class="form-row">
                        <div class="input-group">
                            <label for="promoCode" class="input-label">Promo Code</label>
                            <input type="text" id="promoCode" placeholder="e.g. WEDDING25" required style="text-transform: uppercase;">
                        </div>
                        <div class="input-group">
                            <label for="discountPercent" class="input-label">Discount %</label>
                            <input type="number" id="discountPercent" placeholder="25" min="1" max="100" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="input-group">
                            <label for="promoStartAt" class="input-label">Start Date</label>
                            <input type="datetime-local" id="promoStartAt">
                        </div>
                        <div class="input-group">
                            <label for="promoEndAt" class="input-label">End Date</label>
                            <input type="datetime-local" id="promoEndAt">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="input-group">
                            <label for="usageLimit" class="input-label">Usage Limit (Optional)</label>
                            <input type="number" id="usageLimit" placeholder="100" min="1">
                        </div>
                        <div class="input-group">
                            <label for="promoDescription" class="input-label">Description (Optional)</label>
                            <textarea id="promoDescription" placeholder="Special discount for wedding events"></textarea>
                        </div>
                    </div>
                    <div style="text-align:right">
                        <button type="button" id="cancelPromoEdit" class="btn btn-secondary" style="display:none;margin-right:8px">Cancel</button>
                        <button id="submitPromoBtn" class="btn btn-primary" type="submit">Create Promo Code</button>
                    </div>
                </form>
            </div>

            <div class="card">
                <h3>Existing Promo Codes</h3>
                <div id="promoLoading" class="loading"><i class="fas fa-spinner fa-spin"></i> Loading promo codes...</div>
                <div class="scroll-container" style="display:none" id="promosScrollContainer">
                    <div id="promosContainer" class="offers-grid"></div>
                </div>
            </div>

            <div class="card">
                <h3>Existing Offers</h3>
                <div id="loading" class="loading"><i class="fas fa-spinner fa-spin"></i> Loading offers...</div>
                <div class="scroll-container" style="display:none" id="offersScrollContainer">
                    <div id="offersContainer" class="offers-grid"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="confirmModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-exclamation-circle"></i> Approval Required</h3>
                <span class="close" onclick="closeConfirmModal()">&times;</span>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to post this offer?</p>
                <div style="text-align: left; background: #1a1a1a; padding: 10px; border-radius: 6px; margin-bottom: 10px;">
                    <strong style="color: var(--royal-blue);" id="preview-title">Title</strong><br>
                    <span style="color: #aaa; font-size: 0.9em;" id="preview-desc">Description</span>
                </div>
                <div class="modal-actions">
                    <button class="btn btn-secondary" onclick="closeConfirmModal()">Cancel</button>
                    <button class="btn btn-primary" onclick="confirmAndSubmit()">Confirm & Post</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // API configuration from config.js
        const API_BASE_URL = CONFIG.API_BASE_URL;
        let editingOfferId = null;
        let editingPromoId = null;
        let pendingPayload = null; // Store data while waiting for approval
        let pendingPromoPayload = null;

        // Admin guard — redirect non-admins
        window.addEventListener('load', () => {
            const userRaw = localStorage.getItem('dsis_user');
            if (!userRaw) return window.location.href = '../login.html';
            try {
                const user = JSON.parse(userRaw);
                const userType = user.userType || user.user_type;
                if (userType !== 'admin') return window.location.href = '../main.html';
            } catch (e) { return window.location.href = '../login.html'; }

            loadOffers();
            loadPromoCodes();
            setupImageUpload();
        });

        function logout(){ if(confirm('Logout?')){ localStorage.removeItem('dsis_user'); localStorage.removeItem('dsis_token'); window.location.href = '../login.html'; } }

        function showError(msg){ const m = document.getElementById('messages'); m.innerHTML = `<div class="error">${msg}</div>`; setTimeout(()=>m.innerHTML='',4000); }
        function showSuccess(msg){ const m = document.getElementById('messages'); m.innerHTML = `<div class="success">${msg}</div>`; setTimeout(()=>m.innerHTML='',3000); }

        // === IMAGE UPLOAD FUNCTIONALITY ===
        function setupImageUpload() {
            const imageUpload = document.getElementById('imageUpload');
            const imagePreview = document.getElementById('imagePreview');
            const previewImg = document.getElementById('previewImg');

            imageUpload.addEventListener('change', function(e) {
                const file = e.target.files[0];
                
                if (file) {
                    // Validate file type
                    if (!file.type.startsWith('image/')) {
                        showError('Please select a valid image file');
                        imageUpload.value = '';
                        imagePreview.style.display = 'none';
                        return;
                    }

                    // Validate file size (5MB limit)
                    if (file.size > 5 * 1024 * 1024) {
                        showError('Image file size must be less than 5MB');
                        imageUpload.value = '';
                        imagePreview.style.display = 'none';
                        return;
                    }

                    // Show preview
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        previewImg.src = e.target.result;
                        imagePreview.style.display = 'block';
                    };
                    reader.readAsDataURL(file);
                } else {
                    imagePreview.style.display = 'none';
                }
            });
        }

        // Convert file to base64 for storage/transmission
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        }

        // Generate a unique filename for the uploaded image
        function generateImageFileName(originalName) {
            const timestamp = Date.now();
            const randomStr = Math.random().toString(36).substring(2, 8);
            const extension = originalName.split('.').pop().toLowerCase();
            return `offer_${timestamp}_${randomStr}.${extension}`;
        }

        // === PROMO CODE MANAGEMENT ===
        async function loadPromoCodes(){
            try{
                document.getElementById('promoLoading').style.display = 'block';
                document.getElementById('promosScrollContainer').style.display = 'none';
                
                // Try to load from API, fallback to sample data
                let promoCodes = [];
                try {
                    const res = await fetch(`${API_BASE_URL}/promo-codes`);
                    if (res.ok) {
                        const data = await res.json();
                        promoCodes = data.promoCodes || [];
                    }
                } catch (apiError) {
                    // Load sample data if API is not available
                    promoCodes = getSamplePromoCodes();
                }
                
                renderPromoCodes(promoCodes);
            }catch(err){
                console.error(err); showError('Could not load promo codes.');
                document.getElementById('promoLoading').style.display = 'none';
            }
        }

        function getSamplePromoCodes() {
            return [
                { 
                    id: 1, 
                    code: 'WEDDING25', 
                    discountPercent: 25, 
                    description: 'Special wedding discount',
                    startAt: new Date().toISOString(),
                    endAt: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString(),
                    usageLimit: 100,
                    usageCount: 5,
                    active: true
                },
                { 
                    id: 2, 
                    code: 'DEBUT15', 
                    discountPercent: 15, 
                    description: 'Debut celebration discount',
                    startAt: new Date().toISOString(),
                    endAt: new Date(Date.now() + 60 * 24 * 60 * 60 * 1000).toISOString(),
                    usageLimit: 50,
                    usageCount: 2,
                    active: true
                }
            ];
        }

        function renderPromoCodes(list){
            const container = document.getElementById('promosContainer');
            container.innerHTML = '';
            if (!list || list.length === 0){
                container.innerHTML = '<div style="color:var(--text-muted)">No promo codes found</div>';
            } else {
                list.forEach(p=>{
                    const card = document.createElement('div'); 
                    card.className = 'offer-card';
                    card.style.borderLeftColor = p.active ? 'var(--royal-blue)' : '#dc3545';
                    
                    const header = document.createElement('div');
                    header.innerHTML = `
                        <strong style="color: var(--gold-accent); font-size: 1.2em;">${escapeHtml(p.code)}</strong>
                        <span style="background: var(--royal-blue); color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.8em; margin-left: 10px;">
                            ${p.discountPercent}% OFF
                        </span>
                    `;
                    
                    const desc = document.createElement('div'); 
                    desc.className = 'offer-desc';
                    desc.textContent = p.description || 'No description';
                    
                    const usage = document.createElement('div');
                    usage.style.cssText = 'font-size: 12px; color: var(--text-muted); margin: 8px 0;';
                    const usageCount = p.usageCount || 0;
                    const usageLimit = p.usageLimit || 'Unlimited';
                    usage.innerHTML = `<i class="fas fa-chart-bar"></i> Used: ${usageCount}${usageLimit !== 'Unlimited' ? ` / ${usageLimit}` : ''}`;
                    
                    const dates = document.createElement('div'); 
                    dates.className = 'offer-dates';
                    dates.innerHTML = `<i class="far fa-clock"></i> ${formatDate(p.startAt)} — ${formatDate(p.endAt)}`;
                    
                    const status = document.createElement('div');
                    status.style.cssText = 'font-size: 12px; font-weight: bold; margin: 8px 0;';
                    status.innerHTML = p.active ? 
                        '<span style="color: #28a745;"><i class="fas fa-check-circle"></i> Active</span>' : 
                        '<span style="color: #dc3545;"><i class="fas fa-times-circle"></i> Inactive</span>';
                    
                    const actions = document.createElement('div'); actions.className='offer-actions';
                        const edit = document.createElement('button'); edit.className='btn btn-secondary'; edit.textContent='Edit';
                        edit.onclick = ()=>{
                            editingPromoId = p.id;
                            document.getElementById('promoCode').value = p.code || '';
                            document.getElementById('discountPercent').value = p.discountPercent || '';
                            document.getElementById('promoDescription').value = p.description || '';
                            document.getElementById('usageLimit').value = p.usageLimit || '';
                            if (p.startAt) document.getElementById('promoStartAt').value = new Date(p.startAt).toISOString().slice(0,16);
                            if (p.endAt) document.getElementById('promoEndAt').value = new Date(p.endAt).toISOString().slice(0,16);
                            document.getElementById('submitPromoBtn').textContent = 'Update Promo Code';
                            document.getElementById('cancelPromoEdit').style.display = 'inline-block';
                            document.querySelector('#promoForm').scrollIntoView({ behavior: 'smooth' });
                        };

                        const toggle = document.createElement('button'); 
                        toggle.className = p.active ? 'btn btn-danger' : 'btn btn-primary'; 
                        toggle.textContent = p.active ? 'Deactivate' : 'Activate';
                        toggle.onclick = async ()=>{
                            try{
                                await togglePromoCodeStatus(p.id, !p.active);
                                showSuccess(`Promo code ${!p.active ? 'activated' : 'deactivated'}`);
                                loadPromoCodes();
                            }catch(er){ console.error(er); showError('Failed to update promo code status'); }
                        };

                        const del = document.createElement('button'); del.className='btn btn-danger'; del.textContent='Delete';
                        del.onclick = async ()=>{
                            if(!confirm(`Delete promo code "${p.code}"?`)) return;
                            try{
                                await deletePromoCode(p.id);
                                showSuccess('Promo code deleted');
                                loadPromoCodes();
                            }catch(er){ console.error(er); showError('Failed to delete promo code'); }
                        };
                        actions.appendChild(edit);
                        actions.appendChild(toggle);
                        actions.appendChild(del);
                    
                    card.appendChild(header); 
                    card.appendChild(desc); 
                    card.appendChild(usage);
                    card.appendChild(dates); 
                    card.appendChild(status);
                    card.appendChild(actions);
                    container.appendChild(card);
                });
            }
            document.getElementById('promoLoading').style.display = 'none';
            document.getElementById('promosScrollContainer').style.display = 'block';
        }

        async function togglePromoCodeStatus(id, active) {
            try {
                const res = await fetch(`${API_BASE_URL}/promo-codes/${id}/toggle`, { 
                    method: 'PATCH', 
                    headers: {'Content-Type': 'application/json'}, 
                    body: JSON.stringify({ active }) 
                });
                if (!res.ok) throw new Error('Toggle failed');
                return true;
            } catch (apiError) {
                // Simulate success for demo
                console.log('API not available, simulating promo code toggle');
                return true;
            }
        }

        async function deletePromoCode(id) {
            try {
                const res = await fetch(`${API_BASE_URL}/promo-codes/${id}`, { method: 'DELETE' });
                if (!res.ok) throw new Error('Delete failed');
                return true;
            } catch (apiError) {
                // Simulate success for demo
                console.log('API not available, simulating promo code deletion');
                return true;
            }
        }

        async function loadOffers(){
            try{
                document.getElementById('loading').style.display = 'block';
                document.getElementById('offersScrollContainer').style.display = 'none';
                const res = await fetch(`${API_BASE_URL}/offers`);
                if (!res.ok) throw new Error('Failed to fetch offers');
                const data = await res.json();
                const list = data.offers || [];
                renderOffers(list);
            }catch(err){
                console.error(err); showError('Could not load offers.');
                document.getElementById('loading').style.display = 'none';
            }
        }

        function renderOffers(list){
            const container = document.getElementById('offersContainer');
            container.innerHTML = '';
            if (!list || list.length === 0){
                container.innerHTML = '<div style="color:var(--text-muted)">No offers found</div>';
            } else {
                list.forEach(o=>{
                    const card = document.createElement('div'); card.className = 'offer-card';
                    
                    const title = document.createElement('div'); 
                    title.innerHTML = `<strong>${escapeHtml(o.title||'Untitled')}</strong>`;
                    
                    const desc = document.createElement('div'); 
                    desc.className = 'offer-desc';
                    desc.textContent = o.description || '';
                    
                    const dates = document.createElement('div'); 
                    dates.className = 'offer-dates';
                    dates.innerHTML = `<i class="far fa-clock"></i> ${formatDate(o.startAt)} — ${formatDate(o.endAt)}`;
                    
                    const actions = document.createElement('div'); actions.className='offer-actions';
                        const edit = document.createElement('button'); edit.className='btn btn-secondary'; edit.textContent='Edit';
                        edit.onclick = ()=>{
                            editingOfferId = o.id;
                            document.getElementById('title').value = o.title || '';
                            document.getElementById('description').value = o.description || '';
                            
                            // Clear previous image selection and preview
                            document.getElementById('imageUpload').value = '';
                            document.getElementById('imagePreview').style.display = 'none';
                            
                            // Show existing image if available
                            if (o.imageUrl || o.imageData) {
                                const previewImg = document.getElementById('previewImg');
                                previewImg.src = o.imageData || o.imageUrl;
                                document.getElementById('imagePreview').style.display = 'block';
                                
                                // Add note about existing image
                                const existingNote = document.createElement('div');
                                existingNote.id = 'existing-image-note';
                                existingNote.innerHTML = '<small style="color: var(--gold-accent);">Current image (upload new to replace)</small>';
                                const preview = document.getElementById('imagePreview');
                                if (!document.getElementById('existing-image-note')) {
                                    preview.appendChild(existingNote);
                                }
                            }
                            
                            if (o.startAt) document.getElementById('startAt').value = new Date(o.startAt).toISOString().slice(0,16);
                            if (o.endAt) document.getElementById('endAt').value = new Date(o.endAt).toISOString().slice(0,16);
                            document.getElementById('submitBtn').textContent = 'Update Offer';
                            document.getElementById('cancelEdit').style.display = 'inline-block';
                            window.scrollTo({ top: 0, behavior: 'smooth' });
                        };

                        const del = document.createElement('button'); del.className='btn btn-danger'; del.textContent='Delete';
                        del.onclick = async ()=>{
                            if(!confirm('Delete this offer?')) return;
                            try{
                                const r = await fetch(`${API_BASE_URL}/offers/${o.id}`, { method: 'DELETE' });
                                if (!r.ok) throw new Error('Delete failed');
                                showSuccess('Offer deleted');
                                loadOffers();
                            }catch(er){ console.error(er); showError('Failed to delete offer'); }
                        };
                        actions.appendChild(edit);
                        actions.appendChild(del);
                    card.appendChild(title); card.appendChild(desc); card.appendChild(dates); card.appendChild(actions);
                    container.appendChild(card);
                });
            }
            document.getElementById('loading').style.display = 'none';
            document.getElementById('offersScrollContainer').style.display = 'block';
        }

        // --- PROMO FORM HANDLING ---
        const submitPromoBtn = document.getElementById('submitPromoBtn');
        const cancelPromoBtn = document.getElementById('cancelPromoEdit');

        cancelPromoBtn.addEventListener('click', ()=>{
            editingPromoId = null;
            document.getElementById('promoForm').reset();
            submitPromoBtn.textContent = 'Create Promo Code';
            cancelPromoBtn.style.display = 'none';
        });

        document.getElementById('promoForm').addEventListener('submit', async (e)=>{
            e.preventDefault();
            
            const promoPayload = {
                code: document.getElementById('promoCode').value.trim().toUpperCase(),
                discountPercent: parseInt(document.getElementById('discountPercent').value),
                description: document.getElementById('promoDescription').value.trim(),
                usageLimit: document.getElementById('usageLimit').value ? parseInt(document.getElementById('usageLimit').value) : null,
                startAt: document.getElementById('promoStartAt').value ? new Date(document.getElementById('promoStartAt').value).toISOString() : new Date().toISOString(),
                endAt: document.getElementById('promoEndAt').value ? new Date(document.getElementById('promoEndAt').value).toISOString() : null,
                active: true
            };

            try {
                if (editingPromoId){
                    await updatePromoCode(editingPromoId, promoPayload);
                    showSuccess('Promo code updated successfully');
                } else {
                    await createPromoCode(promoPayload);
                    showSuccess('Promo code created successfully');
                }
                
                // Cleanup
                document.getElementById('promoForm').reset();
                editingPromoId = null;
                submitPromoBtn.textContent = 'Create Promo Code';
                cancelPromoBtn.style.display = 'none';
                loadPromoCodes();
            } catch(err){ 
                console.error(err); 
                showError(editingPromoId ? 'Failed to update promo code' : 'Failed to create promo code'); 
            }
        });

        async function createPromoCode(promoData) {
            try {
                const res = await fetch(`${API_BASE_URL}/promo-codes`, { 
                    method: 'POST', 
                    headers: {'Content-Type': 'application/json'}, 
                    body: JSON.stringify(promoData) 
                });
                if (!res.ok) throw new Error('Create failed');
                return true;
            } catch (apiError) {
                // Simulate success for demo
                console.log('API not available, simulating promo code creation');
                return true;
            }
        }

        // --- OFFER FORM HANDLING ---
        const submitBtn = document.getElementById('submitBtn');
        const cancelBtn = document.getElementById('cancelEdit');

        cancelBtn.addEventListener('click', () => {
            editingOfferId = null;
            document.getElementById('offerForm').reset();
            document.getElementById('imagePreview').style.display = 'none';
            submitBtn.textContent = 'Create Offer';
            cancelBtn.style.display = 'none';
            // Remove existing image note if present
            const existingNote = document.getElementById('existing-image-note');
            if (existingNote) existingNote.remove();
        });

        document.getElementById('offerForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const title = document.getElementById('title').value.trim();
            const description = document.getElementById('description').value.trim();
            const benefits = document.getElementById('benefits').value.trim();
            const startAt = document.getElementById('startAt').value;
            const endAt = document.getElementById('endAt').value;
            const imageFile = document.getElementById('imageUpload').files[0];
            
            if (!title) {
                showError('Please enter an offer title');
                return;
            }
            
            if (!benefits) {
                showError('Please enter the benefits/features of this offer');
                return;
            }
            
            // Handle image upload
            let imageData = null;
            let imageFileName = null;
            if (imageFile) {
                try {
                    imageData = await fileToBase64(imageFile);
                    imageFileName = generateImageFileName(imageFile.name);
                } catch (error) {
                    showError('Failed to process image file');
                    return;
                }
            }
            
            const payload = {
                title,
                description,
                benefits,
                imageData,
                imageFileName,
                startAt: startAt ? new Date(startAt).toISOString() : new Date().toISOString(),
                endAt: endAt ? new Date(endAt).toISOString() : null,
                active: true
            };
            
            // Store pending payload for confirmation
            pendingPayload = payload;
            
            // Show confirmation modal
            document.getElementById('preview-title').textContent = payload.title;
            document.getElementById('preview-desc').textContent = payload.description || '(No description)';
            document.getElementById('confirmModal').style.display = 'block';
        });

        async function updatePromoCode(id, promoData) {
            try {
                const res = await fetch(`${API_BASE_URL}/promo-codes/${id}`, { 
                    method: 'PUT', 
                    headers: {'Content-Type': 'application/json'}, 
                    body: JSON.stringify(promoData) 
                });
                if (!res.ok) throw new Error('Update failed');
                return true;
            } catch (apiError) {
                // Simulate success for demo
                console.log('API not available, simulating promo code update');
                return true;
            }
        }

        // --- MODAL HANDLING ---
        function closeConfirmModal() {
            document.getElementById('confirmModal').style.display = 'none';
            pendingPayload = null;
        }

        async function confirmAndSubmit() {
            if (!pendingPayload) return;
            
            try {
                if (editingOfferId) {
                    // Update existing offer
                    const res = await fetch(`${API_BASE_URL}/offers/${editingOfferId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(pendingPayload)
                    });
                    if (!res.ok) throw new Error('Update failed');
                    showSuccess('Offer updated successfully');
                } else {
                    // Create new offer
                    const res = await fetch(`${API_BASE_URL}/offers`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(pendingPayload)
                    });
                    if (!res.ok) throw new Error('Create failed');
                    showSuccess('Offer created successfully');
                }
                
                // Reset form and reload offers
                document.getElementById('offerForm').reset();
                document.getElementById('imagePreview').style.display = 'none';
                editingOfferId = null;
                document.getElementById('submitBtn').textContent = 'Create Offer';
                document.getElementById('cancelEdit').style.display = 'none';
                
                // Remove existing image note if present
                const existingNote = document.getElementById('existing-image-note');
                if (existingNote) existingNote.remove();
                
                loadOffers();
                closeConfirmModal();
                
            } catch (error) {
                console.error('Error submitting offer:', error);
                showError(editingOfferId ? 'Failed to update offer' : 'Failed to create offer');
            } finally {
                pendingPayload = null;
            }
        }

        // --- UTILITY FUNCTIONS ---
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatDate(dateString) {
            if (!dateString) return 'No date set';
            const date = new Date(dateString);
            return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        }

        // Close modal when clicking outside
        window.addEventListener('click', function(event) {
            const modal = document.getElementById('confirmModal');
            if (event.target === modal) {
                closeConfirmModal();
            }
        });
    </script>
</body>
</html>

